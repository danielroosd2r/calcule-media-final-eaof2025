<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avaliação Final do Estágio</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .container { background:#fff; width:95%; max-width:720px; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    h1, h2, h3 { text-align:center; color:#333; margin:6px 0; }
    fieldset { border:2px solid #007bff; border-radius:8px; margin-top:15px; padding:15px; background:#f9f9f9; }
    legend { font-weight:bold; color:#007bff; padding:0 8px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 640px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .subcampo { border:1px solid #ccc; border-radius:6px; padding:10px; background:#fff; }
    label { display:block; margin-top:4px; font-weight:bold; }
    input, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:15px; margin-top:4px; }
    .row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    button { margin-top:18px; padding:10px 20px; background:#007bff; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; width:100%; }
    button:hover { background:#0056b3; }
    #mensagem { margin-top:20px; font-size:17px; color:#333; text-align:center; line-height:1.5em; word-wrap:break-word; }
    .muted { color:#666; font-size:13px; }
    .warn { background:#fff7d6; border:1px solid #f2d98c; color:#5f4b00; padding:8px; border-radius:6px; margin-top:10px; font-size:14px; }
    .ok { background:#e9fbef; border:1px solid #a4e5b9; color:#125c2f; padding:8px; border-radius:6px; margin-top:10px; font-size:14px; }

    /* Alinhamento do checkbox Caminhada */
    .check { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .check input[type="checkbox"] { margin:0; }
    .row label.check { display:flex; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Avaliação Final do Estágio</h1>
    <h2>EAOF 2025 - Turma PETRUS</h2>

    <label for="nome">Nome do Aluno (opcional):</label>
    <input type="text" id="nome" placeholder="Digite seu nome (opcional)" />

    <!-- PROVAS TEÓRICAS -->
    <fieldset>
      <legend>PROVAS TEÓRICAS</legend>
      <div class="grid grid-3">
        <div class="subcampo">
          <label>Nota de AMT:</label>
          <input type="number" id="notaAMT" step="0.00001" min="0" max="10" placeholder="0 a 10">
        </div>
        <div class="subcampo">
          <label>Nota de ND:</label>
          <input type="number" id="notaND" step="0.00001" min="0" max="10" placeholder="0 a 10">
        </div>
        <div class="subcampo">
          <label>Nota de GP:</label>
          <input type="number" id="notaGP" step="0.00001" min="0" max="10" placeholder="0 a 10">
        </div>
      </div>
    </fieldset>

    <!-- PROVAS PRÁTICAS -->
    <fieldset>
      <legend>PROVAS PRÁTICAS</legend>

      <!-- TACF -->
      <div class="subcampo">
        <h3>TACF</h3>

        <!-- Status + lista de diagnóstico dos CSVs -->
        <div class="warn" id="csvStatus">Carregando tabelas do TACF (CSV)...</div>
        <ul id="csvFilesList" class="muted" style="margin-top:8px"></ul>

        <!-- Painel com as notas por categoria -->
        <div class="ok" id="notasTACFInfo" style="display:none;"></div>

        <div class="grid grid-2">
          <div>
            <label for="tacfSexo">Sexo:</label>
            <select id="tacfSexo">
              <option value="">(selecionar)</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
            </select>
          </div>
          <div>
            <label for="tacfIdade">Idade:</label>
            <input type="number" id="tacfIdade" step="1" min="18" max="100" placeholder="Ex.: 25">
          </div>
        </div>

        <div class="grid grid-3">
          <div>
            <label for="tacfEstatura">Estatura (cm):</label>
            <input type="text" id="tacfEstatura" placeholder="Ex.: 175 ou 1,75">
            <span class="muted">Se digitar em metros (ex.: 1,80), converte p/ 180 cm.</span>
          </div>
          <div>
            <label for="tacfCintura">Cintura (cm):</label>
            <input type="number" id="tacfCintura" step="0.5" placeholder="Ex.: 80.5">
            <span class="muted">Precisão de 0,5 (1 casa decimal).</span>
          </div>
          <div>
            <label for="tacfFlexao">Flexão (repetições):</label>
            <input type="number" id="tacfFlexao" step="1" min="0" placeholder="Ex.: 30">
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="tacfAbdominal">Abdominal (repetições):</label>
            <input type="number" id="tacfAbdominal" step="1" min="0" placeholder="Ex.: 35">
          </div>
          <div>
            <label for="tacfCorrida">Corrida (metros/12min):</label>
            <input type="number" id="tacfCorrida" step="1" min="0" placeholder="Ex.: 2400">
          </div>
        </div>

        <div class="row">
          <label class="check">
            <input type="checkbox" id="tacfCaminhadaCheck">
            <span>Caminhada (4,8 km)</span>
          </label>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="tacfCaminhadaTempo">Caminhada (tempo hh:mm:ss):</label>
            <input type="text" id="tacfCaminhadaTempo" placeholder="Ex.: 00:40:00" disabled>
          </div>
        </div>
      </div>

      <!-- ORDEM UNIDA -->
      <div class="subcampo">
        <h3>ORDEM UNIDA</h3>
        <label>Nota da OU (0–10, até 5 casas):</label>
        <input type="number" id="notaOU" step="0.00001" min="0" max="10" placeholder="0 a 10">
      </div>
    </fieldset>

    <button id="btnCalcular">Calcular Médias</button>
    <p id="mensagem"></p>
  </div>

  <script>
    /* ========= UTILIDADES ========= */
    function toNumberOrNull(v){ if(v===null||v===undefined) return null; const n=parseFloat((''+v).replace(',','.')); return isNaN(n)?null:n; }
    function normalizeEstaturaToCm(raw){
      if(!raw) return null;
      let s=String(raw).trim().replace(',','.');
      s=s.replace(/\s+/g,'');
      const n=parseFloat(s);
      if(isNaN(n)) return null;
      if(n>0 && n<3) return Math.round(n*100); // metros -> cm
      return Math.round(n);                     // já em cm
    }
    function roundToHalf(x){ return Math.round(x*2)/2; }
    function parseHMS(hms){ if(!hms) return null; const m=/^(\d{1,2}):([0-5]\d):([0-5]\d)$/.exec(hms.trim()); if(!m) return null; return parseInt(m[1])*3600+parseInt(m[2])*60+parseInt(m[3]); }

    /* ========= CINTURA (Tabelas embutidas) ========= */
    // Masculino – colunas: [166, 167-171, 172-175, 176-180, 181-188, 189+]
    const OIC01_MASC = {
      "102.0":[0,0,0,0,0,0],"101.5":[0,0,0,0,0,0],"101.0":[0,0,0,0,0,0],"100.5":[0,0,0,0,0,0],
      "100.0":[0,0,0,0,0,0],"99.5":[0,0,0,0,0,0],"99.0":[0,0,0,0,0,0],
      "98.5":[6,6,6,6,6,6],"98.0":[6.4,6.4,6.5,6.5,6.7,6.9],"97.5":[6.7,6.8,6.9,7.1,7.3,7.7],
      "97.0":[7.1,7.2,7.4,7.6,8.0,8.6],"96.5":[7.4,7.6,7.8,8.2,8.7,9.4],
      "96.0":[7.8,8.0,8.3,8.7,9.3,10.3],"95.5":[8.1,8.4,8.8,9.3,10.0,11.1],
      "95.0":[8.5,8.8,9.2,9.8,10.7,12.0],"94.5":[8.8,9.2,9.7,10.4,11.3,13.3],
      "94.0":[9.2,9.6,10.2,10.9,12.0,14.6],"93.5":[9.5,10.0,10.6,11.5,13.0,15.9],
      "93.0":[9.9,10.4,11.1,12.0,14.0,17.1],"92.5":[10.2,10.8,11.5,13.3,15.0,18.4],
      "92.0":[10.6,11.2,12.0,14.6,16.0,19.7],"91.5":[10.9,11.6,13.3,15.9,17.0,21.0],
      "91.0":[11.3,12.0,14.6,17.1,18.0,22.5],"90.5":[11.6,13.3,15.9,18.4,19.0,24.0],
      "90.0":[12.0,14.6,17.1,19.7,20.0,25.5],"89.5":[13.3,15.9,18.4,21.0,21.0,27.0],
      "89.0":[14.6,17.1,19.7,22.5,23.0,27.8],"88.5":[15.9,18.4,21.0,24.0,25.0,28.2],
      "88.0":[17.1,19.7,22.5,25.5,27.0,28.6],"87.5":[18.4,21.0,24.0,27.0,27.8,30.0],
      "87.0":[19.7,22.5,25.5,27.8,28.2,30.0],"86.5":[21.0,24.0,27.0,28.2,28.6,30.0],
      "86.0":[22.5,25.5,27.8,28.6,30.0,30.0],"85.5":[24.0,27.0,28.2,30.0,30.0,30.0],
      "85.0":[25.5,27.8,28.6,30.0,30.0,30.0],"84.5":[27.0,28.2,30.0,30.0,30.0,30.0],
      "84.0":[27.8,28.6,30.0,30.0,30.0,30.0],"83.5":[28.2,30.0,30.0,30.0,30.0,30.0],
      "83.0":[28.6,30.0,30.0,30.0,30.0,30.0],"82.5":[30,30,30,30,30,30]
    };
    function colEstMasc(h){ if(h<=166) return 0; if(h<=171) return 1; if(h<=175) return 2; if(h<=180) return 3; if(h<=188) return 4; return 5; }
    function notaCinturaMasculina(estaturaCm, cinturaCm){
      if(estaturaCm==null || cinturaCm==null) return null;
      const col = colEstMasc(estaturaCm);
      let c = roundToHalf(cinturaCm);
      if(c>102.0) c=102.0; if(c<82.5) c=82.5;
      const row = OIC01_MASC[c.toFixed(1)];
      return row? row[col] : null;
    }

    // Feminino – colunas: [161, 162-166, 167+]
    const OIC05_FEM = {
      "92.0":[0,0,0], "92.5":[0,0,0], "91.5":[0,0,0], "91.0":[0,0,0], "90.5":[0,0,0], "90.0":[0,0,0],
      "89.5":[6,6,6], "89.0":[6.7,6.7,7.2], "88.5":[7.3,7.3,8.4], "88.0":[8.0,8.0,9.6],
      "87.5":[8.7,8.7,10.8], "87.0":[9.3,9.3,12.0], "86.5":[10.0,10.0,14.3], "86.0":[10.7,10.7,15.8],
      "85.5":[11.3,11.3,17.3], "85.0":[12.0,12.0,21.0], "84.5":[13.5,16.5,23.0], "84.0":[15.0,21.0,25.0],
      "83.5":[16.5,23.0,27.0], "83.0":[18.0,25.0,27.8], "82.5":[19.5,27.0,28.2], "82.0":[21.0,27.8,28.6],
      "81.5":[23.0,28.2,30.0], "81.0":[25.0,28.6,30.0], "80.5":[27.0,30.0,30.0], "80.0":[27.8,30.0,30.0],
      "79.5":[28.2,30.0,30.0], "79.0":[28.6,30.0,30.0], "78.5":[30.0,30.0,30.0]
    };
    function colEstFem(h){ if(h<=161) return 0; if(h<=166) return 1; return 2; }
    function notaCinturaFeminina(estaturaCm, cinturaCm){
      if(estaturaCm==null || cinturaCm==null) return null;
      const col = colEstFem(estaturaCm);
      let c = roundToHalf(cinturaCm);
      if(c>92.0) c=92.0; if(c<78.5) c=78.5;
      const row = OIC05_FEM[c.toFixed(1)];
      return row? row[col] : null;
    }

    /* ========= ARQUIVOS CSV ========= */
    const CSV_FILES = {
      flex_m: 'flexao_masculino.csv',
      flex_f: 'flexao_feminino.csv',
      abd_m:  'abdominal_masculino.csv',
      abd_f:  'abdominal_feminino.csv',
      run_m:  'corrida12_masculino.csv',
      run_f:  'corrida12_feminino.csv',
      walk_m: 'caminhada48_masculino.csv',
      walk_f: 'caminhada48_feminino.csv',
    };

    const TABELAS = {
      flex_m: null, flex_f: null,
      abd_m: null, abd_f: null,
      run_m: null, run_f: null,
      walk_m: null, walk_f: null
    };

    /* ========= PARSER CSV ========= */
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(s => s.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(',').map(s => s.trim());
        const obj = {};
        headers.forEach((h,i) => obj[h]=cols[i] ?? '');
        return obj;
      });
      return { headers, rows };
    }

    /* ========= CARREGAMENTO ROBUSTO + DIAGNÓSTICO ========= */
    const CSV_CACHE_BUSTER = () => `v=${Date.now()}`;
    function csvUrl(filename) {
      const u = new URL(filename, window.location.href);
      u.searchParams.set('cb', CSV_CACHE_BUSTER());
      return u.href;
    }

    async function loadCSV(name, filename){
      const url = csvUrl(filename);
      const li = document.querySelector(`#csvFilesList li[data-k="${name}"]`);
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        const parsed = parseCSV(txt);
        TABELAS[name] = parsed;
        if (li) li.innerHTML = `✅ ${filename} — ${parsed.rows.length} linhas, colunas: ${parsed.headers.join(', ')}`;
        return parsed;
      }catch(e){
        if (li) li.innerHTML = `❌ ${filename} — erro ao carregar (${e.message}). URL: ${url}`;
        throw e;
      }
    }

    async function loadAllCSVs(){
      const statusEl = document.getElementById('csvStatus');
      const listEl = document.getElementById('csvFilesList');
      listEl.innerHTML = Object.entries(CSV_FILES)
        .map(([k,v]) => `<li data-k="${k}">⏳ ${v}</li>`).join('');

      try{
        await Promise.all(Object.entries(CSV_FILES).map(([k,v]) => loadCSV(k, v)));
        statusEl.className = 'ok';
        statusEl.textContent = 'Tabelas do TACF carregadas com sucesso.';
      }catch(e){
        statusEl.className = 'warn';
        statusEl.textContent = 'Uma ou mais tabelas não carregaram. Veja os itens ❌ acima.';
        console.error(e);
      }
    }

    /* ========= SELETOR DE FAIXA ETÁRIA (ROBUSTO) ========= */
    function normHeader(s) {
      if (!s) return "";
      return s
        .replace(/\u00A0/g, " ")
        .trim()
        .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g, "-")
        .replace(/\s*-\s*/g, "-");
    }

    function pickAgeColumn(age, headers){
      const rawCols = headers.slice(1);
      const cols = rawCols.map(h => ({ raw: h, norm: normHeader(h) }));

      // 1) cobertura exata
      for (const { raw, norm } of cols) {
        if (/^\d+$/.test(norm)) { if (age === parseInt(norm, 10)) return raw; }
        else if (/^(\d+)\+$/.test(norm)) { const base = parseInt(norm, 10); if (age >= base) return raw; }
        else {
          const m = norm.match(/^(\d+)-(\d+)$/);
          if (m) { const a1 = parseInt(m[1],10), a2 = parseInt(m[2],10); if (age >= a1 && age <= a2) return raw; }
        }
      }

      // 2) faixa mais próxima
      let best = null, bestDist = Infinity;
      function distToRange(age, minv, maxv){ if (age < minv) return (minv - age); if (age > maxv) return (age - maxv); return 0; }
      for (const { raw, norm } of cols) {
        let minv, maxv;
        if (/^\d+$/.test(norm)) { minv = maxv = parseInt(norm,10); }
        else if (/^(\d+)\+$/.test(norm)) { minv = parseInt(norm,10); maxv = 200; }
        else { const m = norm.match(/^(\d+)-(\d+)$/); if (!m) continue; minv = parseInt(m[1],10); maxv = parseInt(m[2],10); }
        const d = distToRange(age, minv, maxv);
        if (d < bestDist) { bestDist = d; best = raw; }
      }
      return best || null;
    }

    /* ========= LOOKUPS ========= */
    function nearestRowValue(rows, keyName, targetNumeric, keyIsTime=false){
      let bestRow=null, bestDiff=Infinity;
      for(const r of rows){
        let val;
        if(keyIsTime){
          const m = /^([0-2]\d):([0-5]\d):([0-5]\d)$/.exec(r[keyName]);
          if(!m) continue;
          val = parseInt(m[1],10)*3600 + parseInt(m[2],10)*60 + parseInt(m[3],10);
        }else{
          val = parseFloat(r[keyName]);
          if(isNaN(val)) continue;
        }
        const diff = Math.abs(val - targetNumeric);
        if(diff < bestDiff){ bestDiff = diff; bestRow = r; }
      }
      return bestRow;
    }

    function getNotaFromCSV(tableParsed, keyName, keyTarget, age, isTime=false){
      if(!tableParsed) return null;
      const {headers, rows} = tableParsed;
      if(!rows.length) return null;
      const ageCol = pickAgeColumn(age, headers);
      if(!ageCol) return null;
      const target = isTime ? keyTarget : parseFloat(keyTarget);
      if(target==null || (isNaN(target) && !isTime)) return null;
      const row = nearestRowValue(rows, keyName, isTime ? keyTarget : target, isTime);
      if(!row) return null;
      const raw = row[ageCol];
      const nota = parseFloat(String(raw).replace(',','.'));
      return isNaN(nota) ? null : nota;
    }

    /* ========= CÁLCULOS TACF ========= */
    function notaCintura(sexo, estaturaCm, cinturaCm){
      if(sexo==='M') return notaCinturaMasculina(estaturaCm, cinturaCm);
      if(sexo==='F') return notaCinturaFeminina(estaturaCm, cinturaCm);
      return null;
    }
    function notaFlexao(sexo, idade, repeticoes){
      if(repeticoes==null) return null;
      const t = (sexo==='M') ? TABELAS.flex_m : (sexo==='F') ? TABELAS.flex_f : null;
      return getNotaFromCSV(t, 'repeticoes', Math.round(repeticoes), idade, false);
    }
    function notaAbdominal(sexo, idade, repeticoes){
      if(repeticoes==null) return null;
      const t = (sexo==='M') ? TABELAS.abd_m : (sexo==='F') ? TABELAS.abd_f : null;
      return getNotaFromCSV(t, 'repeticoes', Math.round(repeticoes), idade, false);
    }
    function notaCorrida12min(sexo, idade, metros){
      if(metros==null) return null;
      const t = (sexo==='M') ? TABELAS.run_m : (sexo==='F') ? TABELAS.run_f : null;
      return getNotaFromCSV(t, 'dist_m', Math.round(metros), idade, false);
    }
    function notaCaminhada48km(sexo, idade, segundos){
      if(segundos==null) return null;
      const t = (sexo==='M') ? TABELAS.walk_m : (sexo==='F') ? TABELAS.walk_f : null;
      return getNotaFromCSV(t, 'tempo_hhmmss', segundos, idade, true);
    }

    /* ========= UI / WORKFLOW ========= */
    document.addEventListener('DOMContentLoaded', async function(){
      const nomeInput   = document.getElementById('nome');

      // Teóricas
      const amtInput    = document.getElementById('notaAMT');
      const ndInput     = document.getElementById('notaND');
      const gpInput     = document.getElementById('notaGP');

      // TACF + subcampos
      const sexoSel     = document.getElementById('tacfSexo');
      const idadeInp    = document.getElementById('tacfIdade');
      const estaturaInp = document.getElementById('tacfEstatura');
      const cinturaInp  = document.getElementById('tacfCintura');
      const flexaoInp   = document.getElementById('tacfFlexao');
      const abdInp      = document.getElementById('tacfAbdominal');
      const corridaInp  = document.getElementById('tacfCorrida');
      const camChk      = document.getElementById('tacfCaminhadaCheck');
      const camTempoInp = document.getElementById('tacfCaminhadaTempo');

      const ouInput     = document.getElementById('notaOU');
      const mensagem    = document.getElementById('mensagem');
      const btn         = document.getElementById('btnCalcular');
      const infoEl      = document.getElementById('notasTACFInfo');

      // Normalizações
      estaturaInp.addEventListener('blur', ()=>{
        const cm = normalizeEstaturaToCm(estaturaInp.value);
        if(cm!==null) estaturaInp.value = String(cm);
      });
      cinturaInp.addEventListener('blur', ()=>{
        const v = toNumberOrNull(cinturaInp.value);
        if(v===null) return;
        cinturaInp.value = roundToHalf(v).toFixed(1);
      });
      function updateCaminhadaState(){
        const checked = camChk.checked;
        corridaInp.disabled = checked;
        camTempoInp.disabled = !checked;
        if(checked) corridaInp.value = ''; else camTempoInp.value='';
      }
      camChk.addEventListener('change', updateCaminhadaState);
      updateCaminhadaState();

      // Carregar CSVs
      await loadAllCSVs();

      btn.addEventListener('click', () => {
        const nome = (nomeInput.value||'').trim();

        // Notas teóricas (0..10)
        const notaAMT  = toNumberOrNull(amtInput.value);
        const notaND   = toNumberOrNull(ndInput.value);
        const notaGP   = toNumberOrNull(gpInput.value);

        // OU (0..10)
        const notaOU   = toNumberOrNull(ouInput.value);

        // Validação das notas de provas
        const notasTeoricas = [notaAMT, notaND, notaGP];
        if (notasTeoricas.some(v => v===null || v<0 || v>10) || notaOU===null || notaOU<0 || notaOU>10) {
          mensagem.textContent = 'Notas de AMT, ND, GP e OU devem ser válidas (0 a 10).';
          return;
        }

        // Subcampos TACF
        const sexo = sexoSel.value || '';
        if(!sexo){ mensagem.textContent = 'Selecione o Sexo para calcular o TACF.'; return; }

        const idadeVal = toNumberOrNull(idadeInp.value);
        if(idadeVal===null || idadeVal<18 || idadeVal>100){ mensagem.textContent='Idade inválida (18–100).'; return; }
        const idade = Math.round(idadeVal);

        const estaturaCm = normalizeEstaturaToCm(estaturaInp.value);
        const cintura = toNumberOrNull(cinturaInp.value);
        if(estaturaCm==null || cintura==null){ mensagem.textContent='Informe Estatura e Cintura para calcular o TACF.'; return; }
        const cinturaAdj = roundToHalf(cintura);

        const flexao = flexaoInp.value.trim()? parseInt(flexaoInp.value,10) : null;
        const abdominal = abdInp.value.trim()? parseInt(abdInp.value,10) : null;

        let corridaM=null, caminhadaSeg=null;
        if (camChk.checked){
          const seg = parseHMS(camTempoInp.value);
          if(seg===null){ mensagem.textContent='Tempo de caminhada inválido. Use hh:mm:ss.'; return; }
          caminhadaSeg = seg;
        } else {
          corridaM = corridaInp.value.trim()? parseInt(corridaInp.value,10) : null;
          if(corridaM===null){ mensagem.textContent='Informe a Corrida (m) ou marque Caminhada com tempo válido.'; return; }
        }

        // CINTURA (0..30)
        const nCintura = notaCintura(sexo, estaturaCm, cinturaAdj);
        if(nCintura==null){ mensagem.textContent='Não foi possível calcular a Nota da Cintura (verifique estatura/cintura).'; return; }

        // FLEXÃO (0..10)
        const nFlex = notaFlexao(sexo, idade, flexao ?? 0);
        if(nFlex==null){ mensagem.textContent='Não foi possível calcular a Nota de Flexão (verifique CSV e repetições).'; return; }

        // ABDOMINAL (0..10)
        const nAbd = notaAbdominal(sexo, idade, abdominal ?? 0);
        if(nAbd==null){ mensagem.textContent='Não foi possível calcular a Nota de Abdominal (verifique CSV e repetições).'; return; }

        // AERÓBICO (0..50)
        let nAer = null;
        if (camChk.checked){
          nAer = notaCaminhada48km(sexo, idade, caminhadaSeg);
        } else {
          nAer = notaCorrida12min(sexo, idade, corridaM);
        }
        if(nAer==null){ mensagem.textContent='Não foi possível calcular a Nota Aeróbica (corrida/caminhada).'; return; }

        // TACF final = (cintura + flexão + abdominal + aeróbico) / 10
        const notaTACF_calc = (nCintura + nFlex + nAbd + nAer) / 10;

        // Médias globais (5 casas decimais)
        const mediaTeorica = ((notaAMT + notaND + notaGP)/3).toFixed(5);
        const mediaPratica = ((notaTACF_calc + notaOU)/2).toFixed(5);
        const mediaEstagio = (((parseFloat(mediaTeorica)*3) + (parseFloat(mediaPratica)*1))/4).toFixed(5);

        // Painel informativo com as notas por categoria
        infoEl.style.display = 'block';
        infoEl.innerHTML = `
          <b>Notas TACF</b><br>
          Cintura: ${nCintura.toFixed(1)} / 30 &nbsp;|&nbsp;
          Flexão: ${nFlex.toFixed(1)} / 10 &nbsp;|&nbsp;
          Abdominal: ${nAbd.toFixed(1)} / 10 &nbsp;|&nbsp;
          ${camChk.checked
            ? `Caminhada: ${nAer.toFixed(1)} / 50`
            : `Corrida: ${nAer.toFixed(1)} / 50`
          }
        `;

        // Resumo detalhado
        const linhas = [];
        linhas.push('Sexo: ' + (sexo==='M'?'Masculino':'Feminino'));
        linhas.push('Idade: ' + idade);
        linhas.push('Estatura: ' + estaturaCm + ' cm');
        linhas.push('Cintura: ' + cinturaAdj.toFixed(1) + ' cm (Nota: ' + nCintura.toFixed(1) + '/30)');
        if(flexao!=null) linhas.push('Flexão: ' + flexao + ' rep (Nota: ' + nFlex.toFixed(1) + '/10)');
        if(abdominal!=null) linhas.push('Abdominal: ' + abdominal + ' rep (Nota: ' + nAbd.toFixed(1) + '/10)');
        if (camChk.checked){
          linhas.push('Caminhada: ' + document.getElementById('tacfCaminhadaTempo').value + ' (Nota: ' + nAer.toFixed(1) + '/50)');
        } else {
          linhas.push('Corrida: ' + corridaM + ' m (Nota: ' + nAer.toFixed(1) + '/50)');
        }
        linhas.push('<b>Nota do TACF (calculada):</b> ' + notaTACF_calc.toFixed(5));

        document.getElementById('mensagem').innerHTML = `
          <b>Aluno:</b> ${ (nome || '(não informado)') }<br><br>
          <b>Média Final das Provas Teóricas:</b> ${mediaTeorica}<br>
          <b>Média Final das Provas Práticas:</b> ${mediaPratica}<br><br>
          <b>Média Final do Estágio:</b> ${mediaEstagio}
          <br><br><u>Detalhes do TACF</u>:<br>${linhas.join('<br>')}
        `;
      });
    });
  </script>
</body>
</html>
